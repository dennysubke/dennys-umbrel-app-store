version: "3.7"

services:
  app_proxy:
    environment:
      APP_HOST: denny-coolify_web_1
      APP_PORT: 80

  db:
    image: postgres:15
    restart: on-failure
    environment:
      POSTGRES_DB: coolify
      POSTGRES_USER: coolify
      POSTGRES_PASSWORD: coolify_password_change_me
      TZ: Europe/Berlin
    volumes:
      - ${APP_DATA_DIR}/data/postgres:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL","pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB"]
      interval: 5s
      timeout: 3s
      retries: 40

  redis:
    image: redis:7-alpine
    restart: on-failure
    command: ["redis-server","--appendonly","yes"]
    volumes:
      - ${APP_DATA_DIR}/data/redis:/data

  docker:
    image: docker:28-dind
    restart: on-failure
    privileged: true
    command: ["--host=unix:///data/docker.sock"]
    environment:
      DOCKER_TLS_CERTDIR: ""
      TZ: Europe/Berlin
    volumes:
      - docker:/data
      - ${APP_DATA_DIR}/data/dind:/var/lib/docker

  init:
    image: ghcr.io/coollabsio/coolify:v3.6.1
    restart: "no"
    env_file:
      - ${APP_DATA_DIR}/data/env/web.env
    environment:
      DB_CONNECTION: pgsql
      DB_HOST: db
      DB_PORT: 5432
      DB_DATABASE: coolify
      DB_USERNAME: coolify
      DB_PASSWORD: coolify_password_change_me
      REDIS_HOST: redis
      REDIS_PORT: 6379
      APP_ENV: production
      APP_DEBUG: "false"
      APP_URL: http://${DEVICE_DOMAIN_NAME}:8527
    volumes:
      - ${APP_DATA_DIR}/data/storage:/var/www/html/storage
    depends_on:
      db:
        condition: service_healthy
    command:
      - /bin/sh
      - -lc
      - |
        set -e
        until pg_isready -h "$DB_HOST" -p "$DB_PORT" -U "$DB_USERNAME" -d "$DB_DATABASE"; do
          sleep 2
        done
        if [ ! -f /var/www/html/storage/.setup_done ]; then
          php artisan key:generate --force
          php artisan migrate --force
          php artisan db:seed --class=ProductionSeeder --force
          touch /var/www/html/storage/.setup_done
        fi

  web:
    image: ghcr.io/coollabsio/coolify:v3.6.1
    restart: on-failure
    env_file:
      - ${APP_DATA_DIR}/data/env/web.env
    environment:
      DB_CONNECTION: pgsql
      DB_HOST: db
      DB_PORT: 5432
      DB_DATABASE: coolify
      DB_USERNAME: coolify
      DB_PASSWORD: coolify_password_change_me
      REDIS_HOST: redis
      REDIS_PORT: 6379
      QUEUE_CONNECTION: database
      CACHE_DRIVER: redis
      SESSION_DRIVER: redis
      APP_ENV: production
      APP_DEBUG: "false"
      APP_URL: http://${DEVICE_DOMAIN_NAME}:8527
      DOCKER_HOST: unix:///data/docker.sock
      COOLIFY_SELF_HOSTED: "true"
      COOLIFY_MIGRATION_ENABLED: "false"
      COOLIFY_SEEDER_ENABLED: "false"
    volumes:
      - ${APP_DATA_DIR}/data/storage:/var/www/html/storage
      - docker:/data
    depends_on:
      init:
        condition: service_completed_successfully
      docker:
        condition: service_started
      redis:
        condition: service_started
      db:
        condition: service_healthy

  sshd:
    image: lscr.io/linuxserver/openssh-server:latest
    restart: on-failure
    environment:
      PUID: "1000"
      PGID: "1000"
      PUBLIC_KEY_FILE: /config/keys/authorized_keys
      SUDO_ACCESS: "false"
      PASSWORD_ACCESS: "false"
      USER_NAME: coolify
      TZ: Europe/Berlin
    volumes:
      - ${APP_DATA_DIR}/data/ssh:/config
    depends_on:
      web:
        condition: service_started

volumes:
  docker:
