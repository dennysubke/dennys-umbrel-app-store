version: "3.7"

services:
  app_proxy:
    environment:
      APP_HOST: denny-arcane_arcane_1
      APP_PORT: 3552
    links:
      - arcane:denny-arcane_arcane_1

  docker:
    image: docker:27.2.0-dind@sha256:f9f72ad901a78f27be922b2d320bbc263174f12919c1b37e6a01f828fa904565
    privileged: true
    network_mode: host
    stop_grace_period: 1m
    restart: on-failure
    environment:
      DOCKER_ENSURE_BRIDGE: "dind0:10.32.0.1/16"
    entrypoint: ["sh", "/entrypoint.sh"]
    command: >
      dockerd
        --bridge dind0
        --data-root /data/data
        --exec-root /data/exec
        --host unix:///data/docker.sock
        --group 998
        --pidfile /data/docker.pid
    volumes:
      - ${APP_DATA_DIR}/entrypoint.sh:/entrypoint.sh
      - ${APP_DATA_DIR}/data/docker:/data
    healthcheck:
      test: ["CMD", "sh", "-c", "[ -S /data/docker.sock ]"]
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 10s

  arcane:
    image: ghcr.io/ofkm/arcane:latest
    command: ["arcane", "--host", "unix:///var/run/docker.sock", "--admin-password-file=/default-password"]
    depends_on:
      docker:
        condition: service_healthy
    group_add:
      - "998"
    volumes:
      - ${APP_DATA_DIR}/data:/app/data
      - ${APP_DATA_DIR}/projects:/app/data/projects
      - ${APP_DATA_DIR}/data/docker/docker.sock:/var/run/docker.sock
      - ${APP_DATA_DIR}/default-password:/default-password:ro
    environment:
      APP_URL: http://${DEVICE_DOMAIN_NAME}:3552
      ENCRYPTION_KEY: 7e4f6b8c3b1a4d209c5f1a0e98b7f64d
      JWT_SECRET: 0c2f8e19d7a44fbfae3c7b95c10e6f58
